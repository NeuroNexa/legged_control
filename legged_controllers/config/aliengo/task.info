# OCS2任务配置文件 for Aliengo robot
# 这个文件定义了最优控制问题的所有方面，包括模型、求解器、代价函数、约束等。
# 大部分参数与A1的配置相同，但针对Aliengo的硬件特性（如关节限制、尺寸）进行了调整。

# 质心动力学模型类型
centroidalModelType             0      // 0: FullCentroidalDynamics, 1: Single Rigid Body Dynamics

# legged_robot_interface: 机器人接口配置
legged_robot_interface
{
  verbose                               false  // 是否显示加载的参数详情
}

# model_settings: 模型相关设置
model_settings
{
  positionErrorGain             0.0
  phaseTransitionStanceTime     0.1

  verboseCppAd                  true
  recompileLibrariesCppAd       false
  modelFolderCppAd              /tmp/legged_control/aliengo # CppAD库文件路径
}

# swing_trajectory_config: 摆动腿轨迹生成参数
swing_trajectory_config
{
  liftOffVelocity               0.2    # 抬腿速度
  touchDownVelocity            -0.4    # 落足速度
  swingHeight                   0.1    # 摆动高度
  swingTimeScale                0.15
}

# --- 最优控制求解器设置 (DDP/SLQ) ---
ddp
{
  algorithm                       SLQ
  nThreads                        3
  threadPriority                  50
  maxNumIterations                1
  minRelCost                      1e-1
  constraintTolerance             5e-3
  displayInfo                     false
  displayShortSummary             false
  checkNumericalStability         false
  debugPrintRollout               false
  debugCaching                    false
  AbsTolODE                       1e-5
  RelTolODE                       1e-3
  maxNumStepsPerSecond            10000
  timeStep                        0.015
  backwardPassIntegratorType      ODE45
  constraintPenaltyInitialValue   20.0
  constraintPenaltyIncreaseRate   2.0
  preComputeRiccatiTerms          true
  useFeedbackPolicy               false
  strategy                        LINE_SEARCH
  lineSearch
  {
    minStepLength                 1e-2
    maxStepLength                 1.0
    hessianCorrectionStrategy     DIAGONAL_SHIFT
    hessianCorrectionMultiple     1e-5
  }
}


# --- 最优控制求解器设置 (SQP) ---
sqp
{
  nThreads                              3
  dt                                    0.015
  sqpIteration                          1
  deltaTol                              1e-4
  g_max                                 1e-2
  g_min                                 1e-6
  inequalityConstraintMu                0.1
  inequalityConstraintDelta             5.0
  projectStateInputEqualityConstraints  true
  printSolverStatistics                 true
  printSolverStatus                     false
  printLinesearch                       false
  useFeedbackPolicy                     false
  integratorType                        RK2
  threadPriority                        50
}

# --- 最优控制求解器设置 (IPM) ---
ipm
{
  nThreads                              3
  dt                                    0.015
  ipmIteration                          1
  deltaTol                              1e-4
  g_max                                 10.0
  g_min                                 1e-6
  computeLagrangeMultipliers            true
  printSolverStatistics                 true
  printSolverStatus                     false
  printLinesearch                       false
  useFeedbackPolicy                     false
  integratorType                        RK2
  threadPriority                        50
  initialBarrierParameter               1e-4
  targetBarrierParameter                1e-4
  barrierLinearDecreaseFactor           0.2
  barrierSuperlinearDecreasePower       1.5
  barrierReductionCostTol               1e-3
  barrierReductionConstraintTol         1e-3
  fractionToBoundaryMargin              0.995
  usePrimalStepSizeForDual              false
  initialSlackLowerBound                1e-4
  initialDualLowerBound                 1e-4
  initialSlackMarginRate                1e-2
  initialDualMarginRate                 1e-2
}

# rollout: 前向仿真设置
rollout
{
  AbsTolODE                       1e-5
  RelTolODE                       1e-3
  timeStep                        0.015
  integratorType                  ODE45
  maxNumStepsPerSecond            10000
  checkNumericalStability         false
}

# mpc: 模型预测控制设置
mpc
{
  timeHorizon                     1.0  ; # 预测时域 [s]
  solutionTimeWindow              -1   ;
  coldStart                       false;

  debugPrint                      false;

  mpcDesiredFrequency             100  ; # MPC频率 [Hz]
  mrtDesiredFrequency             1000 ; # MRT频率 [Hz] (未使用)
}

# initialState: 初始状态向量 (Aliengo站立姿态)
initialState
{
   # 归一化的质心动量: [线动量, 角动量]
   (0,0)  0.0     ; vcom_x
   (1,0)  0.0     ; vcom_y
   (2,0)  0.0     ; vcom_z
   (3,0)  0.0     ; L_x / robotMass
   (4,0)  0.0     ; L_y / robotMass
   (5,0)  0.0     ; L_z / robotMass

   # 基座姿态: [位置, 方向(欧拉角 ZYX)]
   (6,0)  0.0     ; p_base_x
   (7,0)  0.0     ; p_base_y
   (8,0)  0.3     ; p_base_z
   (9,0)  0.0     ; theta_base_z
   (10,0) 0.0     ; theta_base_y
   (11,0) 0.0     ; theta_base_x

   # 腿部关节位置
   (12,0) -0.20   ; LF_HAA
   (13,0)  0.62   ; LF_HFE
   (14,0) -1.24   ; LF_KFE
   (15,0) -0.20   ; LH_HAA
   (16,0)  0.62   ; LH_HFE
   (17,0) -1.24   ; LH_KFE
   (18,0)  0.20   ; RF_HAA
   (19,0)  0.62   ; RF_HFE
   (20,0) -1.24   ; RF_KFE
   (21,0)  0.20   ; RH_HAA
   (22,0)  0.62   ; RH_HFE
   (23,0) -1.24   ; RH_KFE
}

# --- 代价函数权重矩阵 ---

# Q: 状态权重矩阵
Q
{
  scaling 1e+0

  # 权重值与A1配置相同
  (0,0)   15.0     ; vcom_x
  (1,1)   15.0     ; vcom_y
  (2,2)   100.0    ; vcom_z
  (3,3)   10.0     ; L_x / robotMass
  (4,4)   30.0     ; L_y / robotMass
  (5,5)   30.0     ; L_z / robotMass
  (6,6)   1000.0   ; p_base_x
  (7,7)   1000.0   ; p_base_y
  (8,8)   1500.0   ; p_base_z
  (9,9)   100.0    ; theta_base_z
  (10,10) 300.0    ; theta_base_y
  (11,11) 300.0    ; theta_base_x
  (12,12) 5.0     ; LF_HAA
  (13,13) 5.0     ; LF_HFE
  (14,14) 2.5     ; LF_KFE
  (15,15) 5.0     ; LH_HAA
  (16,16) 5.0     ; LH_HFE
  (17,17) 2.5     ; LH_KFE
  (18,18) 5.0     ; RF_HAA
  (19,19) 5.0     ; RF_HFE
  (20,20) 2.5     ; RF_KFE
  (21,21) 5.0     ; RH_HAA
  (22,22) 5.0     ; RH_HFE
  (23,23) 2.5     ; RH_KFE
}

# R: 控制输入权重矩阵
R
{
  scaling 1e-3

  # 足端接触力权重
  (0,0)   5.0       ; left_front_force
  (1,1)   5.0       ; left_front_force
  (2,2)   5.0       ; left_front_force
  (3,3)   5.0       ; right_front_force
  (4,4)   5.0       ; right_front_force
  (5,5)   5.0       ; right_front_force
  (6,6)   5.0       ; left_hind_force
  (7,7)   5.0       ; left_hind_force
  (8,8)   5.0       ; left_hind_force
  (9,9)   5.0       ; right_hind_force
  (10,10) 5.0       ; right_hind_force
  (11,11) 5.0       ; right_hind_force

  # 足端速度权重
  (12,12) 5000.0    ; x
  (13,13) 5000.0    ; y
  (14,14) 5000.0    ; z
  ...
}

# --- 约束设置 ---

# 摩擦锥软约束
frictionConeSoftConstraint
{
  frictionCoefficient    0.3
  mu                     0.1
  delta                  5.0
}

# 自碰撞约束
selfCollision
{
  collisionLinkPairs
  {
    [0] "LF_calf, RF_calf"
    [1] "LH_calf, RH_calf"
    [2] "LF_calf, LH_calf"
    [3] "RF_calf, RH_calf"
    [4] "LF_FOOT, RF_FOOT"
    [5] "LH_FOOT, RH_FOOT"
    [6] "LF_FOOT, LH_FOOT"
    [7] "RF_FOOT, RH_FOOT"
  }
  minimumDistance  0.05
  mu      1e-2
  delta   1e-3
}

# --- 全身控制器(WBC)任务设置 ---

# 关节力矩限制任务 (根据Aliengo电机能力设定)
torqueLimitsTask
{
   (0,0)  35.278   ; HAA
   (1,0)  35.278   ; HFE
   (2,0)  44.4     ; KFE
}

# 摩擦锥任务 (WBC层面)
frictionConeTask
{
  frictionCoefficient    0.3
}

# 摆动腿控制任务
swingLegTask
{
    kp                   350
    kd                   37
}

# WBC中不同任务的权重
weight
{
    swingLeg        100
    baseAccel       1
    contactForce    0.01
}

# --- 状态估计设置 ---

# 卡尔曼滤波器参数 (与A1相同)
kalmanFilter
{
    footRadius                  0.02
    imuProcessNoisePosition     0.02
    imuProcessNoiseVelocity     0.02
    footProcessNoisePosition    0.002
    footSensorNoisePosition     0.005
    footSensorNoiseVelocity     0.1
    footHeightSensorNoise       0.01
}
